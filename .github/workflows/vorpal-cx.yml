name: Vorpal Security Scan with SARIF

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  vorpal_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect all source files
        id: source-files
        run: |
          FILES=$(find . -type f \( -name "*.cs" -o -name "*.java" -o -name "*.js" -o -name "*.py" \))
          echo "SOURCE_FILES=$FILES" >> $GITHUB_ENV

      - name: Debug Check Collected Files
        run: |
          echo "Collected files:"
          echo "${{ env.SOURCE_FILES }}"

      - name: Run Vorpal Security Scan with SARIF Output
        run: |
          mkdir -p reports
          vorpal -s "${{ env.SOURCE_FILES }}" -r reports/vorpal-results.sarif || echo "Scan failed or found no issues."

      - name: Validate SARIF Output
        run: |
          cat reports/vorpal-results.sarif | jq empty || echo "Invalid SARIF format!"

      - name: Upload SARIF report to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/vorpal-results.sarif
          wait-for-processing: true
